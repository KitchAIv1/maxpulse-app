#!/usr/bin/env node

/**
 * Fix duplicate PrivacyInfo.xcprivacy by modifying the Podfile
 * to exclude it from the IQKeyboardManagerSwift resource bundle
 */

const fs = require('fs');
const path = require('path');

const podfilePath = path.join(__dirname, '..', 'ios', 'Podfile');

console.log('üîß Checking Podfile for PrivacyInfo.xcprivacy fix...');

if (!fs.existsSync(podfilePath)) {
  console.log('‚ö†Ô∏è Podfile not found (will be generated by expo prebuild)');
  process.exit(0);
}

let podfileContent = fs.readFileSync(podfilePath, 'utf8');

// Check if fix is already applied
if (podfileContent.includes('Fix duplicate PrivacyInfo.xcprivacy')) {
  console.log('‚úÖ Podfile fix already applied');
  process.exit(0);
}

// Add the fix to post_install hook
const postInstallFix = `
    # Fix duplicate PrivacyInfo.xcprivacy files
    installer.pods_project.targets.each do |target|
      if target.name == 'IQKeyboardManagerSwift'
        puts "üîß Removing duplicate PrivacyInfo.xcprivacy from \#{target.name}"
        target.build_phases.each do |phase|
          if phase.is_a?(Xcodeproj::Project::Object::PBXResourcesBuildPhase)
            phase.files.each do |file|
              if file.file_ref && file.file_ref.path == 'PrivacyInfo.xcprivacy'
                puts "   Removing file reference: \#{file.file_ref.path}"
                phase.remove_file_reference(file.file_ref)
              end
            end
          end
        end
      end
    end`;

// Find the post_install block and add our fix before the closing 'end'
const postInstallRegex = /(post_install do \|installer\|[\s\S]*?)(\n  end\nend)/;

if (postInstallRegex.test(podfileContent)) {
  podfileContent = podfileContent.replace(postInstallRegex, `$1${postInstallFix}$2`);
  fs.writeFileSync(podfilePath, podfileContent, 'utf8');
  console.log('‚úÖ Podfile patched successfully');
} else {
  console.log('‚ö†Ô∏è Could not find post_install block in Podfile');
  process.exit(1);
}

